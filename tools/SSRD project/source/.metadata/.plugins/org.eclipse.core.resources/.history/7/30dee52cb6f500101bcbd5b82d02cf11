package net.SubSpace.SSDR.Main;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.RandomAccessFile;
import java.nio.channels.FileChannel;
import java.nio.channels.FileLock;
import java.nio.channels.OverlappingFileLockException;
import java.util.Scanner;

import javax.swing.JOptionPane;
import javax.swing.UIManager;
import javax.swing.UnsupportedLookAndFeelException;

public class SSDR {
	public static String Directory;
	public static boolean forceRun = false;
	String appName = "SSDR Client";
	static JOptionPane jPane = new JOptionPane();
	static Thread threadicon;
	static Thread threadmenu;
	static Thread threadCheckForUpdates;
	//##Zone List Info##//
	static int[] ZonePort = new int[512];
	static String[] ZoneIP = new String[512];
	static String[] ZoneName = new String[512];
	static boolean[] ZoneUpdate = new boolean[512];
	 private static FileChannel channel;
	    private static FileLock lock;
	static int zoneCount;
	Runtime runtime = Runtime.getRuntime();
	
	static File fileLock;
	
    public static void main(String[] args) {
    	 try {
         UIManager.setLookAndFeel("javax.swing.plaf.metal.MetalLookAndFeel");
     } 
     catch (UnsupportedLookAndFeelException e) {
        // handle exception
     }
     catch (ClassNotFoundException e) {
        // handle exception
     }
     catch (InstantiationException e) {
        // handle exception
     }
     catch (IllegalAccessException e) {
        // handle exception
     }
     for(String s : args)
     {
    	 if(s.equals("FORCERUN"))
    	 {
    		 forceRun = true;
    	 }
     }
    	threadicon = (new Thread(new ThreadIcon(),"Icon Thread"));
    	threadmenu = (new Thread(new ThreadMenu(),"Menu Thread"));
    	threadCheckForUpdates = (new Thread(new ThreadCheckForUpdates(),"Updating Thread"));
    	Initialize();
    	ThreadIcon.initializeIcon();
    	ThreadMenu.initializeMenu();
    	//threadCheckForUpdates.start();
    	threadicon.start();
    	threadmenu.start();
    }    
    
    public static void Initialize()
    {
    	//Some code i found to keep process from duplicating---\
    	if(!forceRun)                                        //|
    	{                                                    //|
    		AppCheckLock check = new AppCheckLock();         //|
    		check.test();                                    //|    		
    	}                                                    //|
    	AppLock lock = new AppLock("SSDR Client");           //|
    	lock.isAppActive();                                  //|
    	//-----------------------------------------------------/
    	
    	
    	File dirtxt = new File(System.getenv("APPDATA") + "/SSDR/AppData/Directory.txt");
    	if(!dirtxt.exists())
    	{
    		retrieveDirectory();
    	}
    	else
    	{
    		try {
				Directory = ThreadReadWrite.readPropertyFile(dirtxt);
			} catch (IOException e) {
	    		retrieveDirectory();
			}
			if(!Directory.startsWith("C:/") && !Directory.startsWith("C:\\"))
			{
	    		retrieveDirectory();
			}
    	}
    
    	try {read();} catch (IOException e) {return;}
    	for(int j = 0; j < zoneCount; j++)
    	{
			//zoneCount++;
			System.out.println(Zonelist[j]);
			String[] temp = Zonelist[j].split(",");
			ZoneName[j] = temp[0];
			File ZoneInfo = new File(System.getenv("APPDATA") + "/SSDR/ZoneData/" + ZoneName[j] + ".txt");
			if(!ZoneInfo.exists())
			{
				try {
					ThreadReadWrite.writeNewPropertyFile(ZoneInfo);
				} catch (IOException e) {
					e.printStackTrace();
				}
			}
			else
			{
				try {
					if(ThreadReadWrite.readPropertyFile(ZoneInfo).equals("true"))
					{
						ZoneUpdate[j] = true;
					}
					else if(ThreadReadWrite.readPropertyFile(ZoneInfo).equals("false"))
					{
						ZoneUpdate[j] = false;
					}
				} catch (IOException e) {
					e.printStackTrace();
				}
			}
			ZoneIP[j] = temp[1]; 			
    	}	
    }

    private boolean CheckRunning()
    {
    	try {
            fileLock = new File
                 (System.getProperty("user.home"), appName + ".tmp");
            channel = new RandomAccessFile(fileLock, "rw").getChannel();

            try {
                lock = channel.tryLock();
            }
            catch (OverlappingFileLockException e) {
                // already locked
                closeLock();
                return true;
            }

            if (lock == null) {
                closeLock();
                return true;
            }

            Runtime.getRuntime().addShutdownHook(new Thread() {
                    // destroy the lock when the JVM is closing
                    public void run() {
                        closeLock();
                        deleteFile();
                    }
                });
            return false;
        }
        catch (Exception e) {
            closeLock();
            return true;
        }
    }
    
    private void closeLock() {
        try { lock.release();  }
        catch (Exception e) {  }
        try { channel.close(); }
        catch (Exception e) {  }
    }

    private void deleteFile() {
        try { fileLock.delete(); }
        catch (Exception e) { }
    }
    public static void retrieveDirectory()
    {
    	boolean validatedDirectory = false;
    	File attempt1 = new File(System.getenv("ProgramFiles") + "/Continuum/");
    	if(!attempt1.exists())
    	{
    		File attempt2 = new File("C:/Condtinuum/");
    		if(!attempt2.exists())
    		{
    			boolean triedOnce = false;
    			while(!validatedDirectory)
    			{
    				if(!triedOnce)
    				{    					
    					Directory = JOptionPane.showInputDialog("Enter Continuum Directory. This will be the only time you need to do so, unless you remove this program.");
    				}
    				else
    				{
    					Directory = JOptionPane.showInputDialog("INVALID DIRECTORY:" + Directory + ". Enter Continuum Directory");
    				}
    				File dir = new File(Directory);
    				if(dir.exists())
    				{
    					if(Directory.endsWith("Continuum/") || Directory.endsWith("Continuum\\") || Directory.endsWith("Continuum"))
    					{
    						if(Directory.endsWith("m") || Directory.endsWith("M"))
    						{
    							Directory = Directory + "/";
    						}
    						validatedDirectory = true;
    		    			try {
    							ThreadReadWrite.writeProperty(new File(System.getenv("APPDATA") + "/SSDR/AppData/Directory.txt"), Directory);
    						} catch (IOException e) {
    							e.printStackTrace();
    						}
    					}
    				}   	
    				triedOnce = true;
    			}    			
    		}
    		else
    		{
    			validatedDirectory = true;
    			try {
    				ThreadReadWrite.writeProperty(new File(System.getenv("APPDATA") + "/SSDR/AppData/Directory.txt"), Directory);
				} catch (IOException e) {
					e.printStackTrace();
				}
    		}
    	}
    	else
    	{
			try {
				ThreadReadWrite.writeProperty(new File(System.getenv("APPDATA") + "/SSDR/AppData/Directory.txt"), Directory);
			} catch (IOException e) {
				e.printStackTrace();
			}
    	}
    }
    
	static String[] Zonelist = new String[256];
	 static void read() throws IOException {
		 	File file = new File(Directory + "/Zone.dat");
		    Scanner scanner = new Scanner(new FileInputStream(file), "UTF8");
		    try {
		    	int count = 0;
		      while (scanner.hasNextLine())
		      { 
		    	  String temp = (scanner.nextLine() /*+ NL*/);
		    	  if(!temp.startsWith("#"))
		    	  {
		    		  Zonelist[count] = temp;		        	
		    		  count++;
		    	  }
		    	zoneCount = count; 
		      }
		    }
		    finally{
		      scanner.close();
		    }
		  }
}
