package net.SubSpace.SSDR.Main;

import java.awt.AWTException;
import java.awt.CheckboxMenuItem;
import java.awt.List;
import java.awt.Menu;
import java.awt.MenuItem;
import java.awt.TrayIcon;
import java.awt.TrayIcon.MessageType;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.ItemEvent;
import java.awt.event.ItemListener;
import java.io.BufferedInputStream;
import java.io.BufferedReader;
import java.io.DataInputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.OutputStreamWriter;
import java.io.UnsupportedEncodingException;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.ArrayList;
import java.util.Scanner;

import javax.swing.JOptionPane;

public class ThreadMenu implements Runnable{

	static MenuItem ZoneList[] = new MenuItem[512];
	static CheckboxMenuItem checkZoneList[] = new CheckboxMenuItem[512];
	static ArrayList<MenuItem> listZone = new ArrayList<MenuItem>();
    static Menu ZoneListMenu = new Menu("Check Zone");
    static Menu checkZoneListMenu = new Menu("Toggle Check Zone");
    static String[] ZoneListNames = new String[1024];
    static File updateFile = new File(System.getenv("APPDATA") + "/SSDR/AppData/Update.txt");
	@Override
	public void run() {
		registerNames();
	}
	
	public void registerNames()
	{
		File file = new File(System.getenv("APPDATA") + "/SSDR/AppData/ZoneList.txt");
		  try{
			  // Open the file that is the first 
			  // command line parameter
			  FileInputStream fstream = new FileInputStream(file);
			  String parentDirName = file.getParent();
			  System.out.println(parentDirName);
			  // Get the object of DataInputStream
			  DataInputStream in = new DataInputStream(fstream);
			  BufferedReader br = new BufferedReader(new InputStreamReader(in));
			  String strLine;
			  //Read File Line By Line
			  while ((strLine = br.readLine()) != null)   {
			  // Print the content on the console
			  System.out.println (strLine);
			  }
			  //Close the input stream
			  in.close();
			    }catch (Exception e){//Catch exception if any
			  System.err.println("Error: " + e.getMessage());
			  }
	}

    public static void initializeMenu()
    {
    	for(int j = 0; j < SSDR.ZoneName.length;j++)
    	{
    		if(SSDR.ZoneName[j] != null)
    		{
    			ZoneList[j] = new MenuItem(SSDR.ZoneName[j]);    			
    		}
    	}
    	for(int j = 0; j < SSDR.ZoneName.length;j++)
    	{
    		if(SSDR.ZoneName[j] != null)
    		{
    			checkZoneList[j] = new CheckboxMenuItem(SSDR.ZoneName[j]);    			
    		}
    	}
        MenuItem aboutItem = new MenuItem("About");
        MenuItem updateExceptionList = new MenuItem("Update Exceptions");
        ThreadIcon.popup.add(checkZoneListMenu);
        MenuItem exitItem = new MenuItem("Exit");
        CheckboxMenuItem toggleUpdates = new CheckboxMenuItem("Toggle Updating");
        
        //Add components to popup menu
        ThreadIcon.popup.add(aboutItem);
        ThreadIcon.popup.addSeparator();
        ThreadIcon.popup.add(toggleUpdates);
        ThreadIcon.popup.add(ZoneListMenu);
        //ThreadIcon.popup.add(update);
        ThreadIcon.popup.addSeparator();
        ThreadIcon.popup.add(updateExceptionList);
        ThreadIcon.popup.addSeparator();
        //Add to menu
        
        for(int j = 0; j < ZoneList.length;j++)
        {
        	if(ZoneList[j] != null)
        	{        		
        		ZoneListMenu.add(ZoneList[j]);
        	}
        	if(ZoneList[j] != null)
        	{
        		final int b = j;
        		ZoneList[j].addActionListener(new ActionListener() {
                    public void actionPerformed(ActionEvent e) {
                    	if(ThreadCheckForUpdates.currentCheckedZone == null)
						{							
                    		new Thread(new ThreadCheck(SSDR.ZoneName[b],SSDR.ZoneIP[b], 39943, true), SSDR.ZoneName[b] + "'s Downloading Thread")
                    		.start();
						}
                    	
                    }
                });
        	}
        }
        for(int j = 0; j < checkZoneList.length;j++)
        {
        	final File file = new File(System.getenv("APPDATA") + "/SSDR/ZoneData/" + SSDR.ZoneName[j] + ".txt");
        	if(checkZoneList[j] != null)
        	{        		
        		checkZoneListMenu.add(checkZoneList[j]);
                boolean isCheckingForUpdatesAlready = true;
                if(file.exists())
                {
                	String temp = null;
                	try {
						temp = ThreadReadWrite.readPropertyFile(file);
					} catch (IOException e1) {
						// TODO Auto-generated catch block
						e1.printStackTrace();
					}
                	if(temp.equals("false"))
                	{
                		isCheckingForUpdatesAlready = false;
                	}
                }
                if(isCheckingForUpdatesAlready)
                {
                	SSDR.ZoneUpdate[j] = true;
                	checkZoneList[j].setState(true);
                }
                else
                {
                	SSDR.ZoneUpdate[j] = false;
                	checkZoneList[j].setState(false);
                }
        	}
        	if(checkZoneList[j] != null)
        	{
        		final int b = j;
        		checkZoneList[j].addItemListener(new ItemListener() {
                    public void itemStateChanged(ItemEvent e) {
                        int cb1Id = e.getStateChange();
                        if (cb1Id == ItemEvent.SELECTED)
                        {
                        	try {
								ThreadReadWrite.writeProperty(file, "true");
								SSDR.ZoneUpdate[b] = true;
                        	} catch (IOException e1) {
								// TODO Auto-generated catch block
								e1.printStackTrace();
							}
                        }
                        else
                        {
                        	try {
								ThreadReadWrite.writeProperty(file, "false");
								SSDR.ZoneUpdate[b] = false;
							} catch (IOException e1) {
								// TODO Auto-generated catch block
								e1.printStackTrace();
							}
            			}
                    }
                });
        	}
        }
        ThreadIcon.popup.add(exitItem);
        
        ThreadIcon.trayIcon.setPopupMenu(ThreadIcon.popup);
        
        try {
        	ThreadIcon.tray.add(ThreadIcon.trayIcon);
        } catch (AWTException e) {
            System.out.println("TrayIcon could not be added.");
            return;
        }
        boolean AllowUpdates = true;
        String AllowUpdate = "null";
        if(updateFile.exists())
        {
        	try {
				AllowUpdate = ThreadReadWrite.readPropertyFile(updateFile);
			} catch (IOException e1) {
				// TODO Auto-generated catch block
				e1.printStackTrace();
			}
			if(AllowUpdate.equals("true"))
			{
				ThreadIcon.setHoverMessage("(Force an update through " + System.getProperty("line.separator")+ "the list of zones by right-clicking" + System.getProperty("line.separator")+ " this icon and going " + System.getProperty("line.separator")+ "Check Zone>\"Zone Name\".)");
				ThreadCheckForUpdates.runChecks = true;
        		SSDR.threadCheckForUpdates = (new Thread(new ThreadCheckForUpdates(),"Updating Thread"));
        		SSDR.threadCheckForUpdates.start();
				toggleUpdates.setState(true);
			}
			else
			{
				ThreadIcon.setHoverMessage("This App is Set to" + System.getProperty("line.separator") + "\"NOT UPDATING\" Status." + System.getProperty("line.separator") + "To Start Auto Updates," + System.getProperty("line.separator") + "Go to \"Auto Updates\"." + System.getProperty("line.separator") +"You can still force updates.");
				ThreadCheckForUpdates.runChecks = false;
				toggleUpdates.setState(false);
			}
        }
        else
        {
        	try {
				ThreadReadWrite.writeProperty(updateFile, "true");
			} catch (IOException e1) {
				// TODO Auto-generated catch block
				e1.printStackTrace();
			}
			ThreadIcon.setHoverMessage("(Force an update through " + System.getProperty("line.separator")+ "the list of zones by right-clicking" + System.getProperty("line.separator")+ " this icon and going " + System.getProperty("line.separator")+ "Check Zone>\"Zone Name\".)");
			ThreadCheckForUpdates.runChecks = true;
    		SSDR.threadCheckForUpdates = (new Thread(new ThreadCheckForUpdates(),"Updating Thread"));
    		SSDR.threadCheckForUpdates.start();
			toggleUpdates.setState(true);
			
        }
        toggleUpdates.addItemListener(new ItemListener() {
            public void itemStateChanged(ItemEvent e) {
                int cb1Id = e.getStateChange();
                if (cb1Id == ItemEvent.SELECTED){
                	if(!ThreadCheckForUpdates.runChecks == true)
                	{      
        				ThreadIcon.setHoverMessage("(Force an update through " + System.getProperty("line.separator")+ "the list of zones by right-clicking" + System.getProperty("line.separator")+ " this icon and going " + System.getProperty("line.separator")+ "Check Zone>\"Zone Name\".)");
                		ThreadCheckForUpdates.runChecks = true;
                		SSDR.threadCheckForUpdates = (new Thread(new ThreadCheckForUpdates(),"Updating Thread"));
                		SSDR.threadCheckForUpdates.start();
                		try {
							ThreadReadWrite.writeProperty(updateFile, "true");
						} catch (IOException e1) {
							// TODO Auto-generated catch block
							e1.printStackTrace();
						}
                	}
                } else {
    				ThreadIcon.setHoverMessage("This App is Set to" + System.getProperty("line.separator") + "\"NOT UPDATING\" Status." + System.getProperty("line.separator") + "To Start Auto Updates," + System.getProperty("line.separator") + "Go to \"Auto Updates\"." + System.getProperty("line.separator") +"You can still force updates.");
                	ThreadCheckForUpdates.runChecks = false;
                	try {
						ThreadReadWrite.writeProperty(updateFile, "false");
					} catch (IOException e1) {
						// TODO Auto-generated catch block
						e1.printStackTrace();
					}
                }
            }
        });
        ThreadIcon.trayIcon.addActionListener(new ActionListener() {
            public void actionPerformed(ActionEvent e) {
                
            	//IF CLICKED TWICE.
            	
            	//JOptionPane.showMessageDialog(null,"This dialog box is run from System Tray");
            }
        });
        
        aboutItem.addActionListener(new ActionListener() {
            public void actionPerformed(ActionEvent e) {
                JOptionPane.showMessageDialog(null,
                        "This is a Application that supports unlimited downloading speeds for SubSpace files. Made by JabJabJab");
            }
        });
        
        updateExceptionList.addActionListener(new ActionListener() {
            public void actionPerformed(ActionEvent e) {
                fetchZoneExceptions();
            }
        });
        
        exitItem.addActionListener(new ActionListener() {
            public void actionPerformed(ActionEvent e) {
            	ThreadIcon.tray.remove(ThreadIcon.trayIcon);
                System.exit(0);
            }
        });
    }
	private static void fetchZoneExceptions()
	{
		URL u;
	      InputStream is = null;
	      DataInputStream dis;
	      String s;
	      try {
			u = new URL("http://dl.dropbox.com/u/31589881/ZoneExceptions.txt");
			is = u.openStream();
			DataInputStream d = new DataInputStream(is); 
			BufferedReader ds = new BufferedReader(new InputStreamReader(is));


			while ((s = ds.readLine()) != null) {
				for(int j = 0;j < SSDR.ZoneIP.length;j++)
				{
					String temp[] = s.split(":");
					if(SSDR.ZoneIP[j].equals(temp[0]))
					{
						System.out.println(SSDR.ZoneName[j] + "'s IP is now:" + temp[1] + ".");
						SSDR.ZoneIP[j] = temp[1];		
					}
				}
	         }
		} catch (MalformedURLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} catch (IOException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		try {
            is.close();
         } catch (IOException ioe) {
            // just going to ignore this one
         }
	}
}
